<style>
    /* Zoom sorununu çözmek için CSS güncellemesi */
    .view-group { 
        position: relative; 
        width: 640px; 
        height: 480px; 
        margin: 20px auto; 
        background: #000; 
        border-radius: 10px; 
        overflow: hidden; 
    }
    video { 
        display: none; /* Video elementini tamamen gizle, sadece canvas kullan */
    }
    canvas { 
        position: absolute; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        object-fit: contain; /* Görüntünün kesilmesini (zoom) engeller */
        transform: scaleX(-1); /* Sadece çizimi aynala */
    }
</style>

<script>
    // onResults fonksiyonunu şu şekilde güncelle
    function onResults(results) {
        statusDiv.innerText = "Sistem Çalışıyor ✅";
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        
        // Görüntüyü canvas'a tam sığacak şekilde çiz (Zoom'u engeller)
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

        if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
            const landmarks = results.multiFaceLandmarks[0];

            // GÜLÜMSEME HESABI
            const mouthLeft = landmarks[61];
            const mouthRight = landmarks[291];
            const smileDist = Math.hypot(mouthLeft.x - mouthRight.x, mouthLeft.y - mouthRight.y);
            
            // Eşiği biraz düşürdük (0.07 yerine 0.05) ve çarpanı ayarladık
            const smileScore = Math.min(100, Math.max(0, (smileDist - 0.05) * 2500));
            document.getElementById('s_score').innerText = Math.round(smileScore);

            // Veriyi gönder (Hassasiyeti test etmek için eşiği Micro:bit kodunda da kontrol et)
            if (Math.round(smileScore) > 10) { // Sadece anlamlı bir hareket varsa gönder
                transmit("S", smileScore);
            }

            // KAŞ HESABI
            const browDist = Math.abs(landmarks[105].y - landmarks[145].y);
            const browScore = Math.min(100, Math.max(0, (browDist - 0.08) * 3000));
            document.getElementById('b_score').innerText = Math.round(browScore);
            transmit("B", browScore);

            // Noktaları Çiz
            canvasCtx.fillStyle = "#00ff96";
            [61, 291, 105, 145].forEach(i => {
                const p = landmarks[i];
                canvasCtx.beginPath();
                canvasCtx.arc(p.x * canvasElement.width, p.y * canvasElement.height, 3, 0, 2 * Math.PI);
                canvasCtx.fill();
            });
        }
        canvasCtx.restore();
    }
</script>
