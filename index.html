<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>YÃ¼z Analizi Projesi</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: white; text-align: center; margin: 0; padding: 20px; }
        .view-group { position: relative; width: 640px; height: 480px; margin: 20px auto; background: #000; border: 4px solid #333; border-radius: 10px; overflow: hidden; }
        video, canvas { position: absolute; top: 0; left: 0; width: 640px; height: 480px; transform: scaleX(-1); }
        .controls { background: #252525; padding: 20px; border-radius: 12px; display: inline-block; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .score-box { font-size: 1.5rem; margin: 10px 0; color: #00ff96; }
        #status { color: #ffcc00; margin-bottom: 15px; font-weight: bold; }
        button { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; margin: 5px; transition: 0.3s; }
        #connect_ble { background: #007bff; }
        #connect_ble:hover { background: #0056b3; }
        #connect_usb { background: #28a745; }
        #connect_usb:hover { background: #1e7e34; }
    </style>
</head>
<body>

    <h1>YÃ¼z Hareket Analizi</h1>
    <div id="status">Sistem baÅŸlatÄ±lÄ±yor, lÃ¼tfen kameraya izin verin...</div>
    
    <div class="controls">
        <button id="connect_ble">ðŸ”µ Bluetooth Micro:bit</button>
        <button id="connect_usb">ðŸŸ¢ USB Micro:bit</button>
        <div class="score-box">GÃ¼lÃ¼mseme: %<span id="s_score">0</span></div>
        <div class="score-box">KaÅŸ Hareketi: %<span id="b_score">0</span></div>
    </div>

    <div class="view-group">
        <video id="input_video" style="opacity: 0;"></video>
        <canvas id="output_canvas"></canvas>
    </div>

<script>
    // Elementleri SeÃ§
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const statusDiv = document.getElementById('status');

    let uartChar; 
    let usbWriter;            
    let lastTime = 0;   

    // --- BAÄžLANTI MANTIÄžI ---
    document.getElementById('connect_ble').onclick = async () => {
        try {
            const device = await navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e']
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
            uartChar = await service.getCharacteristic('6e400002-b5a3-f393-e0a9-e50e24dcca9e');
            statusDiv.innerText = "Bluetooth BaÄŸlandÄ±! âœ…";
        } catch (e) { statusDiv.innerText = "Bluetooth HatasÄ±: " + e.message; }
    };

    document.getElementById('connect_usb').onclick = async () => {
        try {
            const port = await navigator.serial.requestPort();
            await port.open({ baudRate: 115200 });
            usbWriter = port.writable.getWriter();
            statusDiv.innerText = "USB BaÄŸlandÄ±! âœ…";
        } catch (e) { statusDiv.innerText = "USB HatasÄ±: " + e.message; }
    };

    async function transmit(prefix, val) {
        const now = Date.now();
        if (now - lastTime < 300) return; // Saniyede max 3 veri
        lastTime = now;

        const msg = `${prefix}${Math.round(val)}\n`;
        const enc = new TextEncoder();
        try {
            if (uartChar) await uartChar.writeValue(enc.encode(msg));
            if (usbWriter) await usbWriter.write(enc.encode(msg));
        } catch(e) { console.log("GÃ¶nderim hatasÄ±"); }
    }

    // --- YÃœZ Ä°ÅžLEME ---
  function onResults(results) {
        statusDiv.innerText = "Sistem Ã‡alÄ±ÅŸÄ±yor âœ…";
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        // onResults fonksiyonunun iÃ§indeki gÃ¶nderim mantÄ±ÄŸÄ±nÄ± bununla deÄŸiÅŸtir:
if (sScore > 40) {
    send("S", ""); // Sadece 'S' harfi gÃ¶nder (Smile)
} else if (bScore > 40) {
    send("B", ""); // Sadece 'B' harfi gÃ¶nder (Brow)
} else {
    send("X", ""); // 'X' gÃ¶nder (EkranÄ± temizle)
}

// send fonksiyonunu da ÅŸu ÅŸekilde sadeleÅŸtir:
async function send(prefix, val) {
    const now = Date.now();
    if (now - lastSent < 500) return; // YarÄ±m saniyede bir veri gÃ¶nder (BaÄŸlantÄ±yÄ± yormaz)
    lastSent = now;

    const msg = prefix + "\n"; // Sadece "S\n", "B\n" veya "X\n" gider
    const enc = new TextEncoder();
    try {
        if (uartChar) await uartChar.writeValue(enc.encode(msg));
    } catch (e) { console.log("Hata:", e); }
}
        // GÃ¶rÃ¼ntÃ¼yÃ¼ canvas'a tam sÄ±ÄŸacak ÅŸekilde Ã§iz (Zoom'u engeller)
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

        if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
            const landmarks = results.multiFaceLandmarks[0];

            // GÃœLÃœMSEME HESABI
            const mouthLeft = landmarks[61];
            const mouthRight = landmarks[291];
            const smileDist = Math.hypot(mouthLeft.x - mouthRight.x, mouthLeft.y - mouthRight.y);
            
            // EÅŸiÄŸi biraz dÃ¼ÅŸÃ¼rdÃ¼k (0.07 yerine 0.05) ve Ã§arpanÄ± ayarladÄ±k
            const smileScore = Math.min(100, Math.max(0, (smileDist - 0.05) * 2500));
            document.getElementById('s_score').innerText = Math.round(smileScore);

            // Veriyi gÃ¶nder (Hassasiyeti test etmek iÃ§in eÅŸiÄŸi Micro:bit kodunda da kontrol et)
            if (Math.round(smileScore) > 10) { // Sadece anlamlÄ± bir hareket varsa gÃ¶nder
                transmit("S", smileScore);
            }

            // KAÅž HESABI
            const browDist = Math.abs(landmarks[105].y - landmarks[145].y);
            const browScore = Math.min(100, Math.max(0, (browDist - 0.08) * 3000));
            document.getElementById('b_score').innerText = Math.round(browScore);
            transmit("B", browScore);

           
        }
        canvasCtx.restore();
    }

    const faceMesh = new FaceMesh({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`});
    faceMesh.setOptions({ refineLandmarks: true, minDetectionConfidence: 0.5 });
    faceMesh.onResults(onResults);

    const camera = new Camera(videoElement, {
        onFrame: async () => { await faceMesh.send({image: videoElement}); },
        width: 640, height: 480
    });
    camera.start().catch(() => statusDiv.innerText = "KAMERA AÃ‡ILAMADI! LÃ¼tfen izin verin.");

</script>
</body>
</html>

