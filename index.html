<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Yüz Analizi & Micro:bit</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    
    <style>
        body { font-family: sans-serif; background: #121212; color: white; text-align: center; }
        .view-group { position: relative; width: 640px; height: 480px; margin: 20px auto; background: #000; border: 3px solid #333; }
        video, canvas { position: absolute; top: 0; left: 0; width: 640px; height: 480px; transform: scaleX(-1); }
        .panel { background: #222; padding: 15px; border-radius: 8px; display: inline-block; margin: 5px; }
        #status { color: #ffcc00; font-weight: bold; margin: 10px; }
        button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; margin: 5px; }
    </style>
</head>
<body>

    <h2>Yüz Hareket Puanlama</h2>
    <div id="status">Kamera bekleniyor...</div>
    
    <div class="panel">
        <button id="connect_ble" style="background: #00bfff;">Bluetooth ile Bağlan</button>
        <button id="connect_usb" style="background: #28a745;">USB (Kablo) ile Bağlan</button>
    </div>

    <div class="view-group">
        <video id="input_video"></video>
        <canvas id="output_canvas"></canvas>
    </div>

    <div class="panel">
        <div>Gülümseme: %<span id="s_score">0</span></div>
        <div>Şaşkınlık (Kaş): %<span id="b_score">0</span></div>
    </div>

<script>
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const statusDiv = document.getElementById('status');

    let uartCharacteristic; // Bluetooth için
    let writer;            // USB için
    let lastSentTime = 0;   // Veri gönderme hızını sınırlamak için

    // --- BAĞLANTI FONKSİYONLARI ---

    // Bluetooth Bağlantısı
    document.getElementById('connect_ble').addEventListener('click', async () => {
        try {
            const device = await navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e']
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
            uartCharacteristic = await service.getCharacteristic('6e400002-b5a3-f393-e0a9-e50e24dcca9e');
            alert("Bluetooth Başarılı!");
            statusDiv.innerText = "Bluetooth Bağlı ✅";
        } catch (err) {
            console.error(err);
            alert("Bluetooth Bağlantı Hatası!");
        }
    });

    // USB Bağlantısı
    document.getElementById('connect_usb').addEventListener('click', async () => {
        try {
            const port = await navigator.serial.requestPort();
            await port.open({ baudRate: 115200 });
            writer = port.writable.getWriter();
            alert("USB Bağlantısı Başarılı!");
            statusDiv.innerText =
