<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yüz Hareket Puanlama</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; background: #1a1a1a; color: white; }
        .container { position: relative; margin-top: 20px; border-radius: 15px; overflow: hidden; box-shadow: 0 0 20px rgba(0,255,150,0.3); }
        video, canvas { position: absolute; top: 0; left: 0; transform: scaleX(-1); }
        video { position: static; display: block; width: 640px; height: 480px; background: #000; }
        .stats { margin-top: 20px; background: #2d2d2d; padding: 20px; border-radius: 10px; min-width: 300px; }
        .score-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1.2rem; }
        .score-val { font-weight: bold; color: #00ff96; }
    </style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <h2>Yüz Hareket Analizi</h2>
    
    <div class="container">
        <video id="input_video"></video>
        <canvas id="output_canvas" width="640" height="480"></canvas>
    </div>

    <div class="stats">
        <div class="score-row">Gülümseme Puanı: <span id="smile_val" class="score-val">0</span></div>
        <div class="score-row">Göz Açıklığı: <span id="eye_val" class="score-val">0</span></div>
    </div>

<script type="module">
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const smileVal = document.getElementById('smile_val');
    const eyeVal = document.getElementById('eye_val');

    // İki nokta arasındaki mesafeyi hesaplayan fonksiyon
    function getDistance(p1, p2) {
        return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
    }

    function onResults(results) {
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        
        if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
            const landmarks = results.multiFaceLandmarks[0];

            // 1. Gülümseme Analizi (Dudak kenarları arasındaki mesafe)
            const mouthLeft = landmarks[61];
            const mouthRight = landmarks[291];
            const smileDist = getDistance(mouthLeft, mouthRight);
            const smileScore = Math.min(100, Math.max(0, (smileDist - 0.05) * 500)).toFixed(0);
            smileVal.innerText = smileScore + "%";

            // 2. Göz Açıklığı Analizi (Üst ve alt göz kapağı)
            const eyeTop = landmarks[159];
            const eyeBottom = landmarks[145];
            const eyeDist = getDistance(eyeTop, eyeBottom);
            const eyeScore = (eyeDist * 1000).toFixed(0);
            eyeVal.innerText = eyeScore;

            // Yüz noktalarını ekrana çiz (isteğe bağlı)
            for (const point of landmarks) {
                canvasCtx.beginPath();
                canvasCtx.arc(point.x * canvasElement.width, point.y * canvasElement.height, 1, 0, 2 * Math.PI);
                canvasCtx.fillStyle = "#00ff96";
                canvasCtx.fill();
            }
        }