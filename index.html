<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Yüz Analiz Uygulaması</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    
    <style>
        body { font-family: sans-serif; background: #121212; color: white; text-align: center; }
        .view-group { position: relative; width: 640px; height: 480px; margin: 20px auto; background: #000; border: 3px solid #333; }
        video, canvas { position: absolute; top: 0; left: 0; width: 640px; height: 480px; transform: scaleX(-1); }
        .panel { background: #222; padding: 15px; border-radius: 8px; display: inline-block; margin-top: 10px; }
        #status { color: #ffcc00; font-weight: bold; }
    </style>
</head>
<body>

    <h2>Yüz Hareket Puanlama</h2>
    <div id="status">Kamera bekleniyor...</div>
    
    <div class="view-group">
        <video id="input_video"></video>
        <canvas id="output_canvas"></canvas>
    </div>

    <div class="panel">
        <div>Gülümseme: %<span id="s_score">0</span></div>
        <div>Şaşkınlık (Kaş): %<span id="b_score">0</span></div>
    </div>

<script>
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const statusDiv = document.getElementById('status');

    function onResults(results) {
        statusDiv.innerText = "Sistem Çalışıyor ✅";
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        
        if (results.multiFaceLandmarks) {
            for (const landmarks of results.multiFaceLandmarks) {
                // Basit Puanlama Mantığı
                const topLip = landmarks[13];
                const bottomLip = landmarks[14];
                const distance = Math.sqrt(Math.pow(topLip.x - bottomLip.x, 2) + Math.pow(topLip.y - bottomLip.y, 2));
                
                document.getElementById('s_score').innerText = Math.round(distance * 1000);

                // Noktaları Çiz
                canvasCtx.fillStyle = "#00FF00";
                for(let i=0; i<landmarks.length; i+=10) { // Her 10 noktadan birini çiz (performans için)
                    const p = landmarks[i];
                    canvasCtx.beginPath();
                    canvasCtx.arc(p.x * canvasElement.width, p.y * canvasElement.height, 2, 0, 2 * Math.PI);
                    canvasCtx.fill();
                }
            }
        }
        canvasCtx.restore();
    }

    const faceMesh = new FaceMesh({locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
    }});

    faceMesh.setOptions({
        maxNumFaces: 1,
        refineLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    faceMesh.onResults(onResults);

    // Kamera Başlatma
    const camera = new window.Camera(videoElement, {
        onFrame: async () => {
            await faceMesh.send({image: videoElement});
        },
        width: 640,
        height: 480
    });

    camera.start().catch(err => {
        statusDiv.innerText = "Hata: Kamera erişimi engellendi! (Lütfen HTTPS veya Localhost kullanın)";
        console.error(err);
    });
</script>
</body>
</html>
