<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>AI Micro:bit KontrolÃ¼</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f8f9fa; }
        #webcam-container { margin: 20px auto; width: 200px; height: 200px; border: 3px solid #333; border-radius: 10px; background: #eee; }
        .btn { padding: 12px 24px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; margin: 10px; color: white; }
        .btn-blue { background: #007bff; }
        .btn-green { background: #28a745; }
        #label-container { font-size: 22px; font-weight: bold; color: #333; margin-top: 15px; }
        #status-msg { color: #666; margin-top: 10px; font-style: italic; }
    </style>
</head>
<body>

    <h2>AI Araba Kontrol Merkezi</h2>
    
    <button class="btn btn-blue" onclick="connectMicrobit()">1. Micro:bit'e BaÄŸlan</button>
    <button class="btn btn-green" onclick="init()">2. KamerayÄ± BaÅŸlat</button>

    <div id="webcam-container"></div>
    <div id="label-container">Model henÃ¼z yÃ¼klenmedi</div>
    <div id="status-msg">Durum: Bekleniyor...</div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

    <script>
        // Ã–NEMLÄ°: Kendi linkini buraya yapÄ±ÅŸtÄ±r ve sonunda / olduÄŸundan emin ol
        const MODEL_URL = "https://teachablemachine.withgoogle.com/models/SENIN_MODEL_IDN/"; 
        
        let model, webcam, bluetoothChar;

        // YardÄ±mcÄ± Fonksiyon: MesajlarÄ± gÃ¼venli yazdÄ±rÄ±r
        function log(msg) {
            const el = document.getElementById("status-msg");
            if (el) el.innerText = "Durum: " + msg;
            console.log(msg);
        }

        async function connectMicrobit() {
            try {
                log("Cihaz aranÄ±yor...");
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'BBC micro:bit' }],
                    optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e']
                });
                const server = await device.getServer();
                const service = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
                bluetoothChar = await service.getCharacteristic('6e400002-b5a3-f393-e0a9-e50e24dcca9e');
                log("Micro:bit BaÄŸlandÄ±! âœ…");
            } catch (e) {
                log("Bluetooth HatasÄ±: " + e.message);
            }
        }

        async function init() {
            try {
                log("Model yÃ¼kleniyor...");
                model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
                
                log("Kamera hazÄ±rlanÄ±yor...");
                webcam = new tmImage.Webcam(200, 200, true);
                await webcam.setup();
                await webcam.play();
                
                window.requestAnimationFrame(loop);

                const container = document.getElementById("webcam-container");
                if (container) {
                    container.innerHTML = ""; // Ä°Ã§ini temizle
                    container.appendChild(webcam.canvas);
                }
                log("Sistem HazÄ±r! ðŸš€");
            } catch (e) {
                log("BaÅŸlatma HatasÄ±: " + e.message);
                alert("Hata: " + e.message);
            }
        }

        async function loop() {
            webcam.update();
            await predict();
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            const prediction = await model.predict(webcam.canvas);
            let best = { name: "", prob: 0 };

            for (let i = 0; i < model.getTotalClasses(); i++) {
                if (prediction[i].probability > best.prob) {
                    best.prob = prediction[i].probability;
                    best.name = prediction[i].className;
                }
            }

            const labelDiv = document.getElementById("label-container");
            if (labelDiv) {
                labelDiv.innerText = best.name + " (%" + (best.prob * 100).toFixed(0) + ")";
            }

            if (best.prob > 0.85) {
                sendAction(best.name);
            }
        }

        function sendAction(name) {
            if (!bluetoothChar) return;
            let msg = "S\n"; // Dur
            if (name === "Ileri") msg = "F\n";
            if (name === "Sol") msg = "L\n";
            if (name === "Sag") msg = "R\n";

            let encoder = new TextEncoder();
            bluetoothChar.writeValue(encoder.encode(msg)).catch(() => {});
        }
    </script>
</body>
</html>
