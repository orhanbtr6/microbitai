<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Yüz Analizi & Micro:bit</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    
    <style>
        body { font-family: sans-serif; background: #121212; color: white; text-align: center; }
        .view-group { position: relative; width: 640px; height: 480px; margin: 20px auto; background: #000; border: 3px solid #333; }
        video, canvas { position: absolute; top: 0; left: 0; width: 640px; height: 480px; transform: scaleX(-1); }
        .panel { background: #222; padding: 15px; border-radius: 8px; display: inline-block; margin: 5px; }
        #status { color: #ffcc00; font-weight: bold; margin: 10px; }
        button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; margin: 5px; }
    </style>
</head>
<body>

    <h2>Yüz Hareket Puanlama</h2>
    <div id="status">Kamera bekleniyor...</div>
    
    <div class="panel">
        <button id="connect_ble" style="background: #00bfff;">Bluetooth ile Bağlan</button>
        <button id="connect_usb" style="background: #28a745;">USB (Kablo) ile Bağlan</button>
    </div>

    <div class="view-group">
        <video id="input_video" style="display:none"></video>
        <canvas id="output_canvas" width="640" height="480"></canvas>
    </div>

    <div class="panel">
        <div>Gülümseme: %<span id="s_score">0</span></div>
        <div>Şaşkınlık (Kaş): %<span id="b_score">0</span></div>
    </div>

<script>
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const statusDiv = document.getElementById('status');

    let uartCharacteristic; 
    let writer;            
    let lastSentTime = 0;   

    // --- BAĞLANTI FONKSİYONLARI ---
    document.getElementById('connect_ble').addEventListener('click', async () => {
        try {
            const device = await navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e']
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
            uartCharacteristic = await service.getCharacteristic('6e400002-b5a3-f393-e0a9-e50e24dcca9e');
            statusDiv.innerText = "Bluetooth Bağlı ✅";
        } catch (err) {
            console.error(err);
            alert("Bluetooth Bağlantı Hatası!");
        }
    });

    document.getElementById('connect_usb').addEventListener('click', async () => {
        try {
            const port = await navigator.serial.requestPort();
            await port.open({ baudRate: 115200 });
            writer = port.writable.getWriter();
            statusDiv.innerText = "USB Bağlı ✅";
        } catch (err) {
            console.error(err);
            alert("USB Bağlantı Hatası!");
        }
    });

    async function sendData(prefix, value) {
        const now = Date.now();
        if (now - lastSentTime < 300) return; 
        lastSentTime = now;

        const msg = `${prefix}${Math.round(value)}\n`;
        const encoder = new TextEncoder();

        if (uartCharacteristic) {
            await uartCharacteristic.writeValue(encoder.encode(msg));
        } else if (writer) {
            await writer.write(encoder.encode(msg));
        }
    }

    // --- ANALİZ VE ÇİZİM ---
    function onResults(results) {
        statusDiv.innerText = "Sistem Çalışıyor ✅";
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

        if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
            const landmarks = results.multiFaceLandmarks[0];

            // Puanlama
            const sDist = Math.hypot(landmarks[61].x - landmarks[291].x, landmarks[61].y - landmarks[291].y);
            const smileScore = Math.min(100, Math.max(0, (sDist - 0.07) * 2000));
            
            const bDist = Math.abs(landmarks[105].y - landmarks[145].y);
            const browScore = Math.min(100, Math.max(0, (bDist - 0.09) * 2500));

            document.getElementById('s_score').innerText = Math.round(smileScore);
            document.getElementById('b_score').innerText = Math.round(browScore);

            // Veriyi Gönder
            sendData("S", smileScore);

            // Çizim
            canvasCtx.fillStyle = "#00FF96";
            [105, 145, 61, 291].forEach(index
