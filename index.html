<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Araba Mobil</title>
    <style>
        body { font-family: sans-serif; text-align: center; margin: 0; padding: 20px; background: #eee; }
        #webcam-container { margin: 10px auto; width: 200px; height: 200px; border: 5px solid #333; background: #000; border-radius: 10px; position: relative; }
        #webcam-container canvas { width: 100% !important; height: auto !important; border-radius: 5px; }
        .btn { width: 80%; padding: 15px; font-size: 18px; margin: 10px; border-radius: 10px; border: none; color: white; font-weight: bold; }
        .btn-blue { background: #3498db; }
        .btn-green { background: #2ecc71; }
        #status { background: #fff; padding: 10px; margin: 10px; border-radius: 5px; font-size: 14px; color: red; min-height: 20px; }
    </style>
</head>
<body>

    <h2>AI Mobil Kontrol</h2>
    <div id="status">Durum: HazÄ±r. LÃ¼tfen Ã¶nce 1'e basÄ±n.</div>
    
    <button class="btn btn-blue" onclick="connectMicrobit()">1. Micro:bit'e BaÄŸlan</button>
    <button class="btn btn-green" onclick="init()">2. KamerayÄ± BaÅŸlat</button>

    <div id="webcam-container"></div>
    <div id="label-container" style="font-size: 24px; font-weight: bold;"></div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

    <script>
        // Ã–NEMLÄ°: Linkin doÄŸruluÄŸunu kontrol et!
        const URL = "https://teachablemachine.withgoogle.com/models/SENIN_MODEL_IDN/"; 
        
        let model, webcam, labelContainer, maxPredictions;
        let bluetoothChar;

        function updateStatus(msg) {
            document.getElementById("status").innerHTML = msg;
            console.log(msg);
        }

        async function connectMicrobit() {
            try {
                updateStatus("Bluetooth aranÄ±yor...");
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'BBC micro:bit' }],
                    optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e']
                });
                const server = await device.getServer();
                const service = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
                bluetoothChar = await service.getCharacteristic('6e400002-b5a3-f393-e0a9-e50e24dcca9e');
                updateStatus("<span style='color:green'>Micro:bit BaÄŸlandÄ±! âœ…</span>");
            } catch (e) {
                updateStatus("BaÄŸlantÄ± HatasÄ±: " + e.message);
            }
        }

        async function init() {
            updateStatus("Sistem baÅŸlatÄ±lÄ±yor... LÃ¼tfen bekleyin.");
            try {
                // Modeli yÃ¼kle
                updateStatus("Model yÃ¼kleniyor...");
                model = await tmImage.load(URL + "model.json", URL + "metadata.json");
                maxPredictions = model.getTotalClasses();

                // Kamera kurulumu
                updateStatus("Kamera aÃ§Ä±lÄ±yor...");
                const flip = true; 
                webcam = new tmImage.Webcam(200, 200, flip); 
                
                // MOBÄ°L Ä°Ã‡Ä°N KRÄ°TÄ°K: Arka kamera yerine Ã¶n kamerayÄ± zorla
                await webcam.setup({ facingMode: "user" }); 
                
                updateStatus("Kamera oynatÄ±lÄ±yor...");
                await webcam.play();
                
                window.requestAnimationFrame(loop);

                const container = document.getElementById("webcam-container");
                container.innerHTML = "";
                container.appendChild(webcam.canvas);
                
                // Mobilde videonun oynamasÄ± iÃ§in gerekli Ã¶znitelikler
                const video = webcam.webcam;
                video.setAttribute('playsinline', '');
                video.setAttribute('muted', '');
                
                updateStatus("<span style='color:green'>HER ÅžEY HAZIR! ðŸš€</span>");
            } catch (e) {
                updateStatus("HATA: " + e.message);
                alert("BaÅŸlatma hatasÄ±: " + e.message);
            }
        }

        async function loop() {
            webcam.update();
            await predict();
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            const prediction = await model.predict(webcam.canvas);
            let top = { name: "", prob: 0 };
            for (let i = 0; i < maxPredictions; i++) {
                if(prediction[i].probability > top.prob) {
                    top.prob = prediction[i].probability;
                    top.name = prediction[i].className;
                }
            }
            document.getElementById("label-container").innerHTML = top.name;
            if(top.prob > 0.8) sendCommand(top.name);
        }

        function sendCommand(label) {
            if (!bluetoothChar) return;
            let msg = label === "Ileri" ? "F\n" : "S\n";
            bluetoothChar.writeValue(new TextEncoder().encode(msg)).catch(() => {});
        }
    </script>
</body>
</html>
